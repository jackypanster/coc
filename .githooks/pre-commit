#!/bin/bash

# Git pre-commit hook for version consistency validation
# é˜²æ­¢ç‰ˆæœ¬ä¸ä¸€è‡´é—®é¢˜çš„æäº¤å‰æ£€æŸ¥

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${YELLOW}[PRE-COMMIT]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[PRE-COMMIT]${NC} $1"
}

log_error() {
    echo -e "${RED}[PRE-COMMIT]${NC} $1"
}

# æ£€æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬ç›¸å…³æ–‡ä»¶çš„æ›´æ”¹
check_version_related_changes() {
    local version_files=("versions.env" "Dockerfile.base" "build-base.sh" "build.sh" "build-full.sh")
    local changed_files=()
    
    for file in "${version_files[@]}"; do
        if git diff --cached --name-only | grep -q "^$file$"; then
            changed_files+=("$file")
        fi
    done
    
    if [ ${#changed_files[@]} -eq 0 ]; then
        log_info "æ²¡æœ‰ç‰ˆæœ¬ç›¸å…³æ–‡ä»¶çš„æ›´æ”¹ï¼Œè·³è¿‡ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥"
        return 1
    fi
    
    log_info "æ£€æµ‹åˆ°ç‰ˆæœ¬ç›¸å…³æ–‡ä»¶æ›´æ”¹: ${changed_files[*]}"
    return 0
}

# éªŒè¯ versions.env æ ¼å¼
validate_versions_env_format() {
    if [ ! -f "versions.env" ]; then
        log_error "versions.env æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    # æ£€æŸ¥å¿…éœ€å˜é‡
    local required_vars=("NODE_VERSION" "CLAUDE_CODE_VERSION" "CLAUDE_ROUTER_VERSION" "VERSION" "IMAGE_NAME")
    local missing_vars=()
    
    source ./versions.env
    
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            missing_vars+=("$var")
        fi
    done
    
    if [ ${#missing_vars[@]} -gt 0 ]; then
        log_error "versions.env ç¼ºå°‘å¿…éœ€å˜é‡: ${missing_vars[*]}"
        return 1
    fi
    
    # éªŒè¯ç‰ˆæœ¬æ ¼å¼
    if [[ ! $NODE_VERSION =~ ^[0-9]+$ ]]; then
        log_error "NODE_VERSION æ ¼å¼é”™è¯¯: $NODE_VERSION (åº”ä¸ºæ•°å­—)"
        return 1
    fi
    
    if [[ ! $CLAUDE_CODE_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        log_error "CLAUDE_CODE_VERSION æ ¼å¼é”™è¯¯: $CLAUDE_CODE_VERSION (åº”ä¸º x.y.z æ ¼å¼)"
        return 1
    fi
    
    if [[ ! $CLAUDE_ROUTER_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        log_error "CLAUDE_ROUTER_VERSION æ ¼å¼é”™è¯¯: $CLAUDE_ROUTER_VERSION (åº”ä¸º x.y.z æ ¼å¼)"
        return 1
    fi
    
    if [[ ! $IMAGE_NAME =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]]; then
        log_error "IMAGE_NAME æ ¼å¼é”™è¯¯: $IMAGE_NAME (åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦)"
        return 1
    fi
    
    log_success "versions.env æ ¼å¼éªŒè¯é€šè¿‡"
    return 0
}

# æ£€æŸ¥ Dockerfile.base æ˜¯å¦ç§»é™¤äº†ç¡¬ç¼–ç é»˜è®¤å€¼
check_dockerfile_no_defaults() {
    if [ ! -f "Dockerfile.base" ]; then
        log_error "Dockerfile.base æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å¸¦é»˜è®¤å€¼çš„ ARG
    local args_with_defaults=$(grep -c "ARG.*=" Dockerfile.base || true)
    
    if [ "$args_with_defaults" -gt 0 ]; then
        log_error "Dockerfile.base åŒ…å«ç¡¬ç¼–ç é»˜è®¤å€¼ï¼Œå‘ç° $args_with_defaults ä¸ªå¸¦é»˜è®¤å€¼çš„ ARG"
        log_error "è¯·ç§»é™¤æ‰€æœ‰ ARG æŒ‡ä»¤çš„é»˜è®¤å€¼ï¼Œç¡®ä¿ç‰ˆæœ¬é€šè¿‡æ„å»ºå‚æ•°ä¼ å…¥"
        return 1
    fi
    
    # æ£€æŸ¥å¿…éœ€çš„ ARG å£°æ˜
    local required_args=("NODE_VERSION" "CLAUDE_CODE_VERSION" "CLAUDE_ROUTER_VERSION")
    local missing_args=()
    
    for arg in "${required_args[@]}"; do
        if ! grep -q "ARG $arg" Dockerfile.base; then
            missing_args+=("$arg")
        fi
    done
    
    if [ ${#missing_args[@]} -gt 0 ]; then
        log_error "Dockerfile.base ç¼ºå°‘å¿…éœ€çš„ ARG å£°æ˜: ${missing_args[*]}"
        return 1
    fi
    
    log_success "Dockerfile.base æ£€æŸ¥é€šè¿‡"
    return 0
}

# éªŒè¯æ„å»ºè„šæœ¬è¯­æ³•
validate_build_scripts_syntax() {
    local scripts=("build-base.sh" "build.sh" "build-full.sh")
    local failed_scripts=()
    
    for script in "${scripts[@]}"; do
        if [ -f "$script" ]; then
            if ! bash -n "$script"; then
                failed_scripts+=("$script")
            fi
        fi
    done
    
    if [ ${#failed_scripts[@]} -gt 0 ]; then
        log_error "ä»¥ä¸‹æ„å»ºè„šæœ¬è¯­æ³•é”™è¯¯: ${failed_scripts[*]}"
        return 1
    fi
    
    log_success "æ„å»ºè„šæœ¬è¯­æ³•éªŒè¯é€šè¿‡"
    return 0
}

# è¿è¡Œå¿«é€Ÿç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
run_quick_version_check() {
    log_info "è¿è¡Œå¿«é€Ÿç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥..."
    
    # æ£€æŸ¥æ„å»ºè„šæœ¬æ˜¯å¦æ­£ç¡®åŠ è½½ç‰ˆæœ¬é…ç½®
    local scripts=("build-base.sh" "build.sh" "build-full.sh")
    
    for script in "${scripts[@]}"; do
        if [ -f "$script" ]; then
            if ! grep -q "source.*versions.env" "$script"; then
                log_error "$script æœªæ­£ç¡®åŠ è½½ versions.env"
                return 1
            fi
        fi
    done
    
    # æ£€æŸ¥ build-base.sh æ˜¯å¦åŒ…å«ç‰ˆæœ¬éªŒè¯é€»è¾‘
    if [ -f "build-base.sh" ]; then
        if ! grep -q "validate_all_versions" build-base.sh; then
            log_error "build-base.sh ç¼ºå°‘ç‰ˆæœ¬éªŒè¯é€»è¾‘"
            return 1
        fi
    fi
    
    log_success "å¿«é€Ÿç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
    return 0
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹ç‰ˆæœ¬ä¸€è‡´æ€§é¢„æäº¤æ£€æŸ¥..."
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬ç›¸å…³æ–‡ä»¶çš„æ›´æ”¹
    if ! check_version_related_changes; then
        exit 0
    fi
    
    local check_failed=0
    
    # 1. éªŒè¯ versions.env æ ¼å¼
    if ! validate_versions_env_format; then
        check_failed=1
    fi
    
    # 2. æ£€æŸ¥ Dockerfile.base
    if ! check_dockerfile_no_defaults; then
        check_failed=1
    fi
    
    # 3. éªŒè¯æ„å»ºè„šæœ¬è¯­æ³•
    if ! validate_build_scripts_syntax; then
        check_failed=1
    fi
    
    # 4. è¿è¡Œå¿«é€Ÿç‰ˆæœ¬æ£€æŸ¥
    if ! run_quick_version_check; then
        check_failed=1
    fi
    
    if [ $check_failed -eq 1 ]; then
        echo ""
        log_error "âŒ ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼"
        log_error "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡æ–°æäº¤"
        echo ""
        log_info "ğŸ’¡ æç¤ºï¼š"
        log_info "   - è¿è¡Œ ./test-version-consistency.sh è¿›è¡Œå®Œæ•´æµ‹è¯•"
        log_info "   - æ£€æŸ¥ versions.env æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®"
        log_info "   - ç¡®ä¿ Dockerfile.base ç§»é™¤äº†ç¡¬ç¼–ç é»˜è®¤å€¼"
        log_info "   - éªŒè¯æ‰€æœ‰æ„å»ºè„šæœ¬è¯­æ³•æ­£ç¡®"
        echo ""
        exit 1
    fi
    
    log_success "âœ… ç‰ˆæœ¬ä¸€è‡´æ€§é¢„æäº¤æ£€æŸ¥é€šè¿‡ï¼"
    exit 0
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"