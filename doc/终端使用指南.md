# Code on Cloud 终端使用指南

## 终端架构

Code on Cloud 使用 tmux + ttyd + xterm.js 的集成方案，提供强大的Web终端体验：

```
浏览器 (xterm.js) ←WebSocket→ ttyd ←pty→ tmux session
                                      ↓
                                 持久化会话
```

### 核心组件
- **xterm.js**: 前端终端渲染，提供优秀的用户体验
- **ttyd**: WebSocket 终端服务器，处理协议转换
- **tmux**: 终端多路复用器，支持会话管理和窗格分割

## tmux 基础操作

### 前缀键
所有 tmux 命令都需要先按前缀键 `Ctrl+A`，然后按功能键。

### 窗格管理

| 功能 | 快捷键 | 说明 |
|------|--------|------|
| 垂直分割 | `Ctrl+A` 然后 `\|` | 创建左右分割的窗格 |
| 水平分割 | `Ctrl+A` 然后 `-` | 创建上下分割的窗格 |
| 关闭窗格 | `Ctrl+A` 然后 `x` | 关闭当前窗格 |
| 窗格导航 | `Alt+方向键` | 在窗格间切换 |

### 窗口管理

| 功能 | 快捷键 | 说明 |
|------|--------|------|
| 新建窗口 | `Ctrl+A` 然后 `c` | 创建新窗口 |
| 下一个窗口 | `Ctrl+A` 然后 `n` | 切换到下一个窗口 |
| 上一个窗口 | `Ctrl+A` 然后 `p` | 切换到上一个窗口 |
| 窗口列表 | `Ctrl+A` 然后 `w` | 显示所有窗口 |
| 重命名窗口 | `Ctrl+A` 然后 `,` | 重命名当前窗口 |

### 会话管理

| 功能 | 快捷键 | 说明 |
|------|--------|------|
| 分离会话 | `Ctrl+A` 然后 `d` | 断开但保持会话运行 |
| 列出会话 | `tmux ls` | 显示所有会话 |
| 附加会话 | `tmux attach -t main` | 重新连接到会话 |
| 新建会话 | `tmux new -s 项目名` | 创建命名会话 |

## 复制粘贴操作

### 鼠标操作（推荐）
- **选择文本**: 按住鼠标左键拖动
- **复制**: 选择后自动复制到系统剪贴板
- **粘贴**: 右键点击或 `Ctrl+V`
- **双击**: 选择单词
- **三击**: 选择整行

### 键盘操作
1. `Ctrl+A` 然后 `[` 进入复制模式
2. 使用方向键或 vim 键（h/j/k/l）移动光标
3. `v` 开始选择文本
4. `y` 复制并退出复制模式
5. `Ctrl+A` 然后 `]` 粘贴

## Chrome 浏览器优化

### 避免快捷键冲突
以下 Chrome 快捷键在终端中需要注意：
- `Ctrl+T`: 新标签页（避免在终端中使用）
- `Ctrl+W`: 关闭标签页（避免在终端中使用）
- `Ctrl+L`: 地址栏（与终端清屏冲突）
- `Ctrl+D`: 书签（与终端退出冲突）

### 推荐设置
- 使用 `Ctrl+A` 作为 tmux 前缀键（避免与 Chrome 冲突）
- 启用鼠标模式进行窗格操作
- 使用 xterm-256color 终端类型

## 开发工作流

### 典型布局
```
┌─────────────────┬─────────────────┐
│                 │                 │
│   代码编辑      │   文件浏览      │
│   (vim/nano)    │   (ls/tree)     │
│                 │                 │
├─────────────────┼─────────────────┤
│                 │                 │
│   构建/测试     │   日志监控      │
│   (npm/python)  │   (tail -f)     │
│                 │                 │
└─────────────────┴─────────────────┘
```

### 创建开发环境
```bash
# 创建项目会话
tmux new -s myproject

# 分割窗格
Ctrl+A |    # 垂直分割
Ctrl+A -    # 水平分割

# 在不同窗格中运行不同任务
# 窗格1: 编辑代码
vim /workspace/app.js

# 窗格2: 运行服务
npm start

# 窗格3: 监控日志
tail -f /var/log/app.log

# 窗格4: 文件操作
ls -la /workspace
```

## 会话持久化

### 优势
- **断线重连**: 网络断开后会话仍然运行
- **长期任务**: 支持长时间运行的构建或测试
- **多项目**: 为不同项目创建独立会话
- **状态保持**: 工作目录、环境变量等状态保持

### 使用场景
```bash
# 启动长时间任务
npm run build &

# 分离会话（关闭浏览器）
Ctrl+A d

# 稍后重新连接
# 浏览器重新打开，任务仍在运行
```

## 故障排除

### 常见问题

1. **快捷键不响应**
   - 确保焦点在终端窗口内
   - 检查是否被浏览器扩展拦截
   - 尝试刷新页面重新连接

2. **中文显示问题**
   - 确保终端编码设置为 UTF-8
   - 检查字体是否支持中文
   - 在浏览器端使用输入法

3. **复制粘贴问题**
   - Chrome 可能需要授权剪贴板访问
   - 使用鼠标选择通常更可靠
   - 确保 tmux 鼠标模式已启用

4. **会话丢失**
   - 检查容器是否重启
   - 使用 `tmux ls` 查看现有会话
   - 重新附加到会话: `tmux attach -t main`

### 调试命令
```bash
# 查看 tmux 状态
tmux info

# 查看所有会话
tmux ls

# 查看当前会话信息
tmux display-message -p '#S:#I:#P'

# 重新加载配置
tmux source-file ~/.tmux.conf
```

## 高级技巧

### 自定义配置
如需修改 tmux 配置，可以编辑 `/etc/tmux.conf`：
```bash
# 修改前缀键为 Ctrl+Space（如果与 Chrome 冲突）
unbind C-a
set -g prefix C-Space
bind C-Space send-prefix

# 启用鼠标支持
set -g mouse on

# 设置历史记录大小
set -g history-limit 10000
```

### 脚本自动化
```bash
# 创建开发环境脚本
#!/bin/bash
tmux new-session -d -s dev
tmux split-window -h
tmux split-window -v
tmux send-keys -t 0 'vim .' Enter
tmux send-keys -t 1 'npm start' Enter
tmux send-keys -t 2 'tail -f logs/app.log' Enter
tmux attach-session -t dev
```

### 多用户协作
```bash
# 创建共享会话
tmux new -s shared

# 其他用户连接到同一会话
tmux attach -t shared
```

## 性能优化

- tmux 会话在后台运行，不占用前端资源
- xterm.js 提供硬件加速的终端渲染
- WebSocket 连接提供低延迟的实时交互
- 容器化隔离确保稳定性和安全性