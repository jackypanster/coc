# Code on Cloud 认证系统指南

## 系统概述

Code on Cloud 采用可插拔的认证架构，支持多种认证方式，通过配置文件控制认证提供者的选择。

## 支持的认证方式

### 1. SSO 认证（生产环境）
- 集成企业 SSO 系统
- 支持 OAuth 2.0 标准流程
- 支持账号密码和扫码登录
- 自动用户信息获取

### 2. 本地认证（开发环境）
- 简化的认证流程
- 接受任意用户名密码
- 无需外部依赖

## 快速配置

### 1. 环境配置

复制并编辑配置文件：
```bash
cp login/.env.example login/.env
```

### 2. SSO 模式配置

在 `login/.env` 中设置：
```bash
AUTH_PROVIDER=sso
GFT_CLIENT_ID=your_client_id
GFT_CLIENT_SECRET=your_client_secret
GFT_OAUTH_URL=https://your-sso-server/oauth/authorize
GFT_TOKEN_URL=https://your-sso-server/oauth/token
GFT_USERINFO_URL=https://your-sso-server/api/userinfo
```

### 3. 本地模式配置

在 `login/.env` 中设置：
```bash
AUTH_PROVIDER=local
```

## 认证流程

### SSO 认证流程
1. 用户访问系统 → 重定向到登录页面
2. 点击 SSO 登录 → 打开认证 iframe
3. 完成 SSO 认证 → 获取认证码
4. 后端验证认证码 → 换取访问令牌
5. 获取用户信息 → 建立会话
6. 跳转到终端界面

### 本地认证流程
1. 用户访问系统 → 显示登录表单
2. 输入任意用户名密码 → 提交表单
3. 后端验证通过 → 建立会话
4. 跳转到终端界面

## 会话管理

### 会话配置
- **绝对超时**: 12 小时
- **不活跃超时**: 1 小时
- **Cookie 安全**: HTTP-only, SameSite=strict

### 会话清理
- 自动清理过期会话
- 用户主动登出清理
- 服务重启时清理所有会话

## 自定义认证提供者

### 1. 创建认证模块

在 `login/auth-providers/` 目录下创建新模块：
```
login/auth-providers/custom/
├── index.js       # 认证逻辑
└── login.html     # 登录页面
```

### 2. 实现认证类

```javascript
const AuthProvider = require('../../auth-provider');

class CustomAuthProvider extends AuthProvider {
    constructor() {
        super({
            maxAge: 12 * 60 * 60 * 1000,      // 12小时
            maxInactivity: 60 * 60 * 1000     // 1小时
        });
    }

    async initialize() {
        console.log('自定义认证提供者初始化');
    }

    async getLoginPage() {
        const fs = require('fs');
        const path = require('path');
        return fs.readFileSync(
            path.join(__dirname, 'login.html'), 
            'utf8'
        );
    }

    async authenticate(req, res) {
        const { username, password } = req.body;
        
        // 实现认证逻辑
        if (this.validateCredentials(username, password)) {
            return {
                id: username,
                name: username,
                email: `${username}@example.com`,
                type: 'custom'
            };
        }
        
        throw new Error('认证失败');
    }

    validateCredentials(username, password) {
        // 自定义验证逻辑
        return username && password;
    }
}

module.exports = CustomAuthProvider;
```

### 3. 配置使用

在 `login/.env` 中设置：
```bash
AUTH_PROVIDER=custom
```

## 前端开发指南

### UI 定制
- 修改 `login/auth-providers/*/login.html` 文件
- 自定义 CSS 样式和交互逻辑
- 保持与后端 API 的通信协议

### 开发测试
1. 设置 `AUTH_PROVIDER=local` 进行本地测试
2. 修改 HTML 文件后刷新浏览器查看效果
3. 使用浏览器开发者工具调试

### API 接口
- `GET /login/config` - 获取认证配置
- `POST /login/sso` - SSO 认证提交
- `POST /login/local` - 本地认证提交
- `GET /login` - 获取登录页面

## 安全考虑

### 认证安全
- 使用 HTTPS 传输敏感信息
- HTTP-only Cookie 防止 XSS
- 合理的会话超时策略
- 不在日志中记录敏感信息

### 配置安全
- 敏感配置使用环境变量
- 生产环境禁用本地认证
- 定期更新认证凭据

## 故障排除

### 常见问题

1. **认证提供者加载失败**
   - 检查 `AUTH_PROVIDER` 配置是否正确
   - 确认认证模块文件是否存在
   - 查看容器日志中的错误信息

2. **SSO 认证失败**
   - 验证 `GFT_CLIENT_ID` 和 `GFT_CLIENT_SECRET`
   - 检查 SSO 服务器网络连接
   - 确认重定向 URL 配置正确

3. **会话过期太快**
   - 检查系统时间是否正确
   - 调整会话超时配置
   - 确认用户活跃度检测正常

### 调试方法

1. **启用详细日志**
   ```bash
   # 在容器中查看日志
   docker logs -f cloud-code-dev
   ```

2. **测试认证接口**
   ```bash
   # 测试配置接口
   curl http://localhost/login/config
   
   # 测试本地认证
   curl -X POST http://localhost/login/local \
     -H "Content-Type: application/json" \
     -d '{"username":"test","password":"test"}'
   ```

3. **浏览器调试**
   - 打开开发者工具查看网络请求
   - 检查 Console 中的错误信息
   - 查看 Cookie 设置是否正确

## 部署建议

### 开发环境
- 使用本地认证模式
- 启用详细日志输出
- 允许 HTTP 连接

### 生产环境
- 使用 SSO 认证模式
- 配置 HTTPS 证书
- 设置合理的会话超时
- 定期更新认证凭据

### 监控指标
- 认证成功/失败率
- 会话创建和过期数量
- 用户登录活跃度
- 系统响应时间