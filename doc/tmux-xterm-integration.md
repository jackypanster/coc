# tmux 和 xterm.js 集成方案

## 概述

本次优化将 tmux（终端多路复用器）和 xterm.js（前端终端模拟器）集成到 Code on Cloud，提供更强大的终端体验。

## 架构设计

```
浏览器 (xterm.js) ←WebSocket→ ttyd ←pty→ tmux session
                                      ↓
                                 持久化会话
```

### 核心组件
- **xterm.js**: 前端终端渲染，提供更好的用户体验
- **ttyd**: 成熟的 WebSocket 终端服务器，处理协议和信号
- **tmux**: 会话管理，支持窗口分割、会话持久化

## 实现细节

### 1. tmux 集成
- 在基础镜像中安装 tmux
- 配置开发友好的快捷键和主题
- ttyd 启动时自动创建/附加 tmux 会话

### 2. xterm.js 前端
- 替代 ttyd 内置的终端界面
- 自定义主题和快捷键提示
- 响应式布局，支持终端大小调整

### 3. 路由调整
- `/terminal` - 新的 xterm.js 终端页面
- `/ws` - WebSocket 连接端点（代理到 ttyd）
- 登录成功后自动跳转到终端页面

## tmux 使用指南

### 基础快捷键
所有 tmux 命令需要先按前缀键 `Ctrl+A`，然后按功能键：

| 功能 | 快捷键 |
|------|--------|
| 垂直分割窗格 | `Ctrl+A` 然后 `|` |
| 水平分割窗格 | `Ctrl+A` 然后 `-` |
| 创建新窗口 | `Ctrl+A` 然后 `c` |
| 下一个窗口 | `Ctrl+A` 然后 `n` |
| 上一个窗口 | `Ctrl+A` 然后 `p` |
| 关闭当前窗格 | `Ctrl+A` 然后 `x` |
| 窗格间切换 | `Alt+方向键` |

### 会话管理
- 容器重启后，tmux 会话仍然存在
- 默认会话名称为 `main`
- 可创建多个会话进行不同项目开发

## 测试步骤

1. **构建基础镜像**（如果需要）
   ```bash
   ./build-base.sh
   ```

2. **构建应用镜像**
   ```bash
   ./build.sh
   ```

3. **启动容器**
   ```bash
   ./start.sh
   ```

4. **访问终端**
   - 浏览器打开 http://localhost
   - 使用本地认证模式登录
   - 自动进入 tmux 会话

## 优势

1. **会话持久化**: 断开连接后工作状态保留
2. **多窗口管理**: 同时处理多个任务
3. **更好的复制粘贴**: xterm.js 原生支持
4. **自定义主题**: 可根据需要调整界面
5. **性能优秀**: ttyd + tmux 组合经过生产验证

## 未来优化方向

1. **React 组件化**: 将 xterm.js 封装为 React 组件
2. **会话列表**: 显示和管理多个 tmux 会话
3. **配置持久化**: 保存用户的终端偏好设置
4. **协作功能**: 支持多用户共享会话

## 技术栈

- **前端**: 原生 HTML/CSS/JavaScript + xterm.js
- **后端**: Node.js + Express + http-proxy-middleware
- **终端**: ttyd (WebSocket) + tmux (会话管理)
- **认证**: 插件化认证系统（SSO/本地）