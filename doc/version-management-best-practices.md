# 动态版本管理最佳实践指南

## 概述

本文档描述了项目中动态版本管理系统的最佳实践，帮助开发团队正确使用和维护版本配置。

## 版本管理原则

### 1. 单一数据源原则
- **所有版本信息都应在 `versions.env` 文件中定义**
- 避免在 Dockerfile 或其他配置文件中硬编码版本号
- 确保版本信息的一致性和可维护性

### 2. 语义版本控制
- 使用语义版本格式 (MAJOR.MINOR.PATCH) 管理 NPM 包版本
- 主版本号：不兼容的 API 修改
- 次版本号：向下兼容的功能性新增
- 修订版本号：向下兼容的问题修正

### 3. 版本验证
- 在构建前验证所有版本格式的正确性
- 确保所有必需的版本变量都已定义
- 提供清晰的错误信息和修复建议

## 版本配置管理

### versions.env 文件结构
```bash
# Docker 镜像版本
VERSION=v1.0.0                    # 项目版本标签
IMAGE_NAME=cloud-code-dev          # Docker 镜像名称

# NPM 包版本
CLAUDE_CODE_VERSION=1.0.54         # Claude Code 包版本
CLAUDE_ROUTER_VERSION=1.0.26       # Claude Router 包版本

# Node.js 版本
NODE_VERSION=20                    # Node.js 主版本号
```

### 版本格式要求

#### NODE_VERSION
- **格式**: 数字
- **示例**: `20`, `18`, `16`
- **说明**: Node.js 主版本号，必须是 Node.js 官方支持的版本

#### CLAUDE_*_VERSION
- **格式**: x.y.z（语义版本）
- **示例**: `1.0.54`, `2.1.0`
- **说明**: NPM 包的语义版本号

#### VERSION
- **格式**: vx.y.z
- **示例**: `v1.0.0`, `v2.1.3`
- **说明**: 项目版本标签，以 'v' 开头

#### IMAGE_NAME
- **格式**: 小写字母、数字、连字符
- **示例**: `cloud-code-dev`, `my-app`
- **说明**: Docker 镜像名称，符合 Docker 命名规范

## 版本更新流程

### 1. 更新版本号
1. 编辑 `versions.env` 文件
2. 根据变更类型选择合适的版本号
3. 确保版本格式符合要求

### 2. 验证更新
1. 运行版本一致性测试：`./test-version-consistency.sh`
2. 检查构建脚本是否正常工作
3. 验证 Docker 构建是否成功

### 3. 提交变更
1. 提交 `versions.env` 文件的修改
2. 在提交信息中说明版本变更的原因
3. 标记相应的 Git 标签（如果是发布版本）

## 构建脚本使用

### 基础镜像构建
```bash
# 构建基础镜像
./build-base.sh

# 构建完整镜像
./build-full.sh

# 构建开发镜像
./build.sh
```

### 版本验证
```bash
# 运行版本一致性测试
./test-version-consistency.sh

# 查看当前版本配置
cat versions.env
```

## 团队协作规范

### 1. 版本更新权限
- 只有项目维护者可以更新生产版本号
- 开发人员可以更新开发和测试版本号
- 重大版本更新需要团队评审

### 2. 版本发布流程
1. **开发阶段**: 使用开发版本号（如 1.0.0-dev）
2. **测试阶段**: 使用候选版本号（如 1.0.0-rc1）
3. **生产发布**: 使用正式版本号（如 1.0.0）

### 3. 版本回滚
- 保留历史版本的 `versions.env` 配置
- 在需要时可以快速回滚到稳定版本
- 记录版本变更历史和回滚原因

## 监控和维护

### 1. 版本一致性检查
- 定期运行版本一致性测试
- 在 CI/CD 流程中集成版本验证
- 监控版本不一致的警告

### 2. 依赖版本管理
- 定期检查 NPM 包的安全更新
- 评估 Node.js 版本的兼容性
- 计划版本升级的时间表

### 3. 文档维护
- 及时更新版本管理文档
- 记录版本变更的影响和注意事项
- 分享版本管理的经验和教训

## 常见问题

### Q: 如何选择合适的版本号？
A: 遵循语义版本控制原则：
- 修复 bug：增加修订版本号
- 新增功能：增加次版本号
- 破坏性变更：增加主版本号

### Q: 版本更新后构建失败怎么办？
A: 
1. 检查版本号格式是否正确
2. 验证 NPM 包版本是否存在
3. 查看构建日志中的详细错误信息
4. 参考故障排除指南

### Q: 如何处理版本冲突？
A: 
1. 与团队成员沟通版本更新计划
2. 使用版本控制系统解决冲突
3. 在合并前运行版本一致性测试

## 相关文档

- [故障排除指南](./version-management-troubleshooting.md)
- [版本一致性测试文档](./version-consistency-testing.md)
- [项目设计文档](./design.md)