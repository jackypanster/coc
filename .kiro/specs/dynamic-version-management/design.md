# 动态版本管理系统设计文档

## 概述

当前系统存在版本不一致的问题：`versions.env` 文件中的版本号与 `Dockerfile.base` 中硬编码的版本号不同步。本设计提供一个动态版本管理解决方案，确保所有 Docker 构建都从 `versions.env` 文件中读取最新的版本信息，消除手动同步的需要。

## 架构

### 当前架构问题
- `Dockerfile.base` 中硬编码版本号（NODE_VERSION=20, CLAUDE_CODE_VERSION=1.0.54, CLAUDE_ROUTER_VERSION=1.0.26）
- `versions.env` 中有更新的版本号（CLAUDE_CODE_VERSION=1.0.64, CLAUDE_ROUTER_VERSION=1.0.31）
- 构建脚本已经从 `versions.env` 读取版本，但 Dockerfile.base 没有使用这些参数

### 目标架构
```
versions.env (单一数据源)
    ↓
构建脚本 (build-base.sh, build.sh, build-full.sh)
    ↓
Docker 构建参数 (--build-arg)
    ↓
Dockerfile.base (移除硬编码默认值)
```

## 组件和接口

### 1. 版本配置文件 (versions.env)
**职责**: 作为所有版本信息的单一数据源
**接口**: 
- 提供标准化的环境变量格式
- 支持注释和分组
- 包含版本验证格式

**当前格式**:
```bash
# Docker 镜像版本
VERSION=v1.0.0
IMAGE_NAME=cloud-code-dev

# NPM 包版本
CLAUDE_CODE_VERSION=1.0.64
CLAUDE_ROUTER_VERSION=1.0.31

# Node.js 版本
NODE_VERSION=20
```

### 2. 构建脚本增强
**职责**: 读取版本配置并传递给 Docker 构建
**当前状态**: 已经正确实现，无需修改
**接口**:
- 输入: versions.env 文件
- 输出: Docker 构建参数

### 3. Dockerfile 修改
**职责**: 接受构建参数，移除硬编码默认值
**修改点**:
- `Dockerfile.base`: 移除 ARG 的默认值，确保必须从构建脚本传入
- 保持向后兼容性

### 4. 版本验证组件
**职责**: 验证版本格式和完整性
**实现方式**: 在构建脚本中添加验证逻辑

## 数据模型

### 版本配置模型
```bash
# 必需的版本变量
NODE_VERSION: 数字 (例: 20, 18, 16)
CLAUDE_CODE_VERSION: 语义版本 (例: 1.0.64)
CLAUDE_ROUTER_VERSION: 语义版本 (例: 1.0.31)
VERSION: 版本标签 (例: v1.0.0)
IMAGE_NAME: 镜像名称 (例: cloud-code-dev)
```

### 验证规则
- NODE_VERSION: 必须是有效的 Node.js 版本号
- CLAUDE_*_VERSION: 必须符合语义版本格式 (x.y.z)
- VERSION: 必须以 'v' 开头的版本标签
- IMAGE_NAME: 必须是有效的 Docker 镜像名称

## 错误处理

### 1. 文件缺失处理
- **场景**: versions.env 文件不存在
- **处理**: 构建脚本立即退出，显示清晰错误信息
- **当前状态**: 已实现

### 2. 版本变量缺失处理
- **场景**: versions.env 中缺少必需的版本变量
- **处理**: 在构建前验证所有必需变量，缺失时显示具体缺少的变量

### 3. 版本格式验证
- **场景**: 版本号格式不正确
- **处理**: 验证版本号格式，不符合时显示格式要求

### 4. Docker 构建失败处理
- **场景**: 版本号导致的构建失败（如不存在的包版本）
- **处理**: 显示详细的错误信息，建议检查版本号有效性

## 测试策略

### 1. 单元测试
- 版本验证函数测试
- 配置文件解析测试

### 2. 集成测试
- 完整构建流程测试
- 版本一致性验证测试

### 3. 错误场景测试
- 缺失文件测试
- 无效版本格式测试
- 构建失败恢复测试

### 4. 回归测试
- 现有构建脚本兼容性测试
- 多环境构建测试

## 实现计划

### 阶段 1: Dockerfile 修改
1. 修改 `Dockerfile.base`，移除 ARG 默认值
2. 确保所有版本参数都通过构建参数传入

### 阶段 2: 版本验证增强
1. 在构建脚本中添加版本验证逻辑
2. 实现详细的错误报告

### 阶段 3: 文档和测试
1. 更新构建文档
2. 添加测试用例
3. 创建故障排除指南

### 阶段 4: 验证和部署
1. 在测试环境验证
2. 确保向后兼容性
3. 部署到生产环境

## 向后兼容性

- 现有构建脚本无需修改
- Docker Compose 配置保持不变
- 容器运行时行为不变
- 只是确保版本一致性，不改变功能

## 性能考虑

- 版本验证增加的构建时间可忽略不计（< 1秒）
- Docker 缓存机制保持不变
- 构建性能不受影响

## 安全考虑

- versions.env 文件应该被版本控制跟踪
- 避免在版本号中包含敏感信息
- 确保版本验证不会泄露系统信息